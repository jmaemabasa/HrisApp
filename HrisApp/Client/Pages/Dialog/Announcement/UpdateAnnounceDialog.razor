@inject IAnnouncementService AnnouncementService
@inject StateService StateService
@inject IDialogService DialogService
@inject GlobalConfigService GlobalConfigService
@inject IAuditlogService AuditlogService

<MudDialog>
    <DialogContent>
        @if (!isShowUpdate)
        {
            <div class="row">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="diatitle">Announcement</span>
                    <MudTooltip Text="Update">
                        <MudIconButton OnClick="UpdateClick" Icon="@Icons.Material.Rounded.Edit" aria-label="update"></MudIconButton>
                    </MudTooltip>
                </div>
                <div class="col-12  mb-2  d-flex flex-column">
                    <span class="title">Duration</span>
                    @if (obj.DateStart != null)
                    {
                        @if ((obj.DateStart.Value.Date == DateTime.Now.Date && obj.DateEnd.Value.Date >= DateTime.Now.Date)
                       || (obj.DateStart.Value.Date <= DateTime.Now.Date && obj.DateEnd.Value.Date >= DateTime.Now.Date))
                        {
                            <span class="announceShow">@obj.DateStart?.ToString("MMM dd") - @obj.DateEnd?.ToString("MMM dd")</span>
                        }
                        else if (obj.DateStart.Value.Date > DateTime.Now.Date)
                        {
                            <span class="announcePending">@obj.DateStart?.ToString("MMM dd") - @obj.DateEnd?.ToString("MMM dd")</span>
                        }
                        else
                        {
                            <span class="announceNotShow">@obj.DateStart?.ToString("MMM dd") - @obj.DateEnd?.ToString("MMM dd")</span>
                        }
                    }
                </div>
                <div class="col-12 mb-2 d-flex flex-column">
                    <span class="title">Title</span>
                    <span class="obj">@obj.Ann_Title</span>
                </div>
                <div class="col-12  mb-2  d-flex flex-column" style="text-align: justify; text-justify: inter-word; white-space: pre-line;">
                    <span class="title">Description</span>
                    <span class="desc">@obj.Ann_Desc</span>
                </div>
                
            </div>
        }

        @if (isShowUpdate)
        {
            <div class="row">
                <div class="d-flex justify-content-between align-items-center mb-4 mt-2">
                    <span class="diatitle">Update Announcement</span>
                </div>

                <div class="col-12">
                    <MudText Typo="Typo.body2">Title</MudText>
                    <MudTextField @bind-Value="obj.Ann_Title" Variant="Variant.Outlined" Margin="Margin.Dense" Style="margin-bottom: 5px;" />
                </div>
                <div class="col-12">
                    <MudText Typo="Typo.body2">Description</MudText>
                    <MudTextField @bind-Value="obj.Ann_Desc" Lines="5" Variant="Variant.Outlined" Margin="Margin.Dense" Style="margin-bottom: 5px;" />
                </div>
                <div class="col-12">
                    <MudText Typo="Typo.body2">Start Date</MudText>
                    <MudDatePicker @bind-Date="obj.DateStart" Placeholder="Select Date" Editable="true" Mask="@(new DateMask("MM/dd/yyyy"))" DateFormat="MM/dd/yyyy" Variant="Variant.Outlined" Margin="Margin.Dense" Style="margin-bottom: 5px;" />
                </div>
                <div class="col-12">
                    <MudText Typo="Typo.body2">End Date</MudText>
                    <MudDatePicker @bind-Date="obj.DateEnd" Placeholder="Select Date" Editable="true" Mask="@(new DateMask("MM/dd/yyyy"))" DateFormat="MM/dd/yyyy" Variant="Variant.Outlined" Margin="Margin.Dense" Style="margin-bottom: 10px;" />
                </div>
            </div>
        }
    </DialogContent>
    <DialogActions>
        <div style="padding: 8px 16px">
            @if (isShowUpdate)
            {
                <MudButton Color="Color.Primary" @onclick="ConfirmUpdate">Save</MudButton>
                <MudButton OnClick="Cancel">Cancel</MudButton>
            }
            else
            {
                <MudButton OnClick="Cancel">Cancel</MudButton>
            }
        </div>
    </DialogActions>
</MudDialog>

@code {
    #nullable disable

    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public int Id { get; set; }

    private AnnouncementT obj = new();

    private bool isShowUpdate;

    protected override async Task OnParametersSetAsync()
    {
        obj = await AnnouncementService.GetSingleAnnouncement((int)Id);
    }


    void Cancel() => MudDialog.Cancel();

    private void UpdateClick()
    {
        isShowUpdate = true;
    }

    private async Task ConfirmUpdate()
    {
        obj.DateStart = obj.DateStart.Value.Date + DateTime.Now.TimeOfDay;
        await AnnouncementService.UpdateAnnouncement(obj);

        await AuditlogService.CreateLog(Int32.Parse(GlobalConfigService.User_Id), "UPDATE", "Model", DateTime.Now);
        obj = await AnnouncementService.GetSingleAnnouncement((int)Id);

        isShowUpdate = false;
        StateService.SetState("AnnouncementList", await AnnouncementService.GetAnnouncementList());
    }
}
