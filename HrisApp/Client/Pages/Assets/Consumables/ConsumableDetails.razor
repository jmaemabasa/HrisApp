@page "/asset-consumable/details/{id:int}"
@attribute [Authorize(Roles = "CadAdmin, SysAdmin, GenAdmin, Technical")]

<PageTitle>Asset Details</PageTitle>

<MudGrid Spacing="3">
    <MudItem xs="12" lg="3">
        <div class="mainassleft" style="margin-top: 10px;">
            <div class="d-flex flex-column justify-content-center ">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="spantitle">Consumable Asset</span>
                </div>
                <div class="d-flex flex-column gap-2" style="margin-top: 1rem;">
                    <div class="d-flex justify-content-center">
                        <div class="asset-img">
                            <img class="asset-img-img" alt="asset image" src="@ConsumableImageData" />
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-center">
                            <span class="asset-code">@obj.AssetCode</span>
                        </div>
                        <div class="d-flex justify-content-center">
                            <span class="" style="color: #757A90;margin-bottom: 10px;">@obj.Cons_Name</span>
                        </div>
                    </div>

                    <div class="divsingledetails">
                        <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Type</MudText>
                        <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.Type?.AType_Name</MudText>
                    </div>
                    <div class="divsingledetails">
                        <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Category</MudText>
                        <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.Category?.ACat_Name</MudText>
                    </div>
                    <div class="divsingledetails">
                        <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Sub Category</MudText>
                        <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.SubCategory?.ASubCat_Name</MudText>
                    </div>
                    <div class="divsingledetails">
                        <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Location</MudText>
                        <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.Area?.Name</MudText>
                    </div>
                    <div class="divsingledetails">
                        <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Quantity</MudText>
                        <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.Quantity @obj.UOM?.Code</MudText>
                    </div>

                    <div class="divsingledetails">
                        <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Created By</MudText>
                        <AssetCreatedBy Id="@obj.CreatedById" />
                    </div>
                </div>
            </div>
        </div>
    </MudItem>

    <MudItem xs="12" lg="9">
        <div class="mainassmain">
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" @ref="Tabs" @bind-ActivePanelIndex="activeIndex">
                <MudTabPanel TabContent="TabHeader(0)">
                    <div class="mainasssec">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="spantitle">Details</span>
                            <AuthorizeView Roles="CadAdmin, SysAdmin, GenAdmin, Technical">
                                <Authorized>
                                    <button class="Btn" onclick="@(() => OpenDrawer(Anchor.End, "detailsPanelOpen"))">

                                        <div class="sign"><MudIcon Icon="@Icons.Material.Rounded.Edit"></MudIcon></div>

                                        <div class="text">Update</div>
                                    </button>
                                </Authorized>
                            </AuthorizeView>
                        </div>
                        <MudGrid Spacing="2">
                            <MudItem xs="12" sm="6">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Asset</MudText>
                                    <MudText Align="Align.Start" Style="color: #27374D; font-weight:bold;" Typo="Typo.body2">@obj.AssetCode</MudText>
                                </div>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Location</MudText>
                                    <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.Area?.Name</MudText>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="4">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Type</MudText>
                                    <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.Type?.AType_Name</MudText>
                                </div>
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Category</MudText>
                                    <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.Category?.ACat_Name</MudText>
                                </div>
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Sub Category</MudText>
                                    <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.SubCategory?.ASubCat_Name</MudText>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Name</MudText>
                                    <MudText Align="Align.Start" Style="color: #27374D; font-weight:bold;" Typo="Typo.body2">@obj.Cons_Name</MudText>
                                </div>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Description</MudText>
                                    <MudText Align="Align.Start" Style="color: #27374D; font-weight:bold;" Typo="Typo.body2">@obj.Cons_Desc</MudText>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Product ID</MudText>
                                    <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.ProductID</MudText>
                                </div>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Quantity</MudText>
                                    <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.Quantity @obj.UOM?.Code</MudText>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Purchase Date</MudText>
                                    <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.PurchaseDate?.ToString("MMM dd yyyy")</MudText>
                                </div>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Purchase Amount</MudText>
                                    <MudText Align="Align.Start" Style="color: #757A90; font-weight:bold;" Typo="Typo.body2">@obj.TotalPurchaseAmount</MudText>
                                </div>
                            </MudItem>
                            <MudItem xs="12" sm="12">
                                <div class="divsingledetails">
                                    <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Remarks</MudText>
                                    <div class="d-flex flex-wrap">
                                        @if (REMARKS.Count != 0)
                                        {
                                            @foreach (var item in REMARKS)
                                            {
                                                <MudChip Text="orange" Variant="Variant.Filled" Style="color: #4b4e5c; background-color: rgba(117, 122, 144,.1);">@item.Remark</MudChip>
                                            }
                                        }
                                        else
                                        {
                                            <span style="font-weight: bold;color: #fafaf5">No Information</span>
                                        }
                                    </div>
                                </div>
                            </MudItem>
                        </MudGrid>
                    </div>
                </MudTabPanel>
                <MudTabPanel TabContent="TabHeader(1)">
                    <div class="mainasssec">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="spantitle">Transanctions</span>
                            <AuthorizeView Roles="CadAdmin, SysAdmin, GenAdmin, Technical">
                                <Authorized>
                                    <button class="btn-returned" @onclick="OpenAddTransDialog">
                                        <MudIcon Icon="@Icons.Material.Rounded.Add" Class="me-1"></MudIcon> Transaction
                                    </button>
                                </Authorized>
                            </AuthorizeView>
                        </div>
                        <div style="margin-bottom: 11px;">
                            <MudMenu PopoverClass="popMenu" FullWidth="true" Dense="true">
                                <ActivatorContent>
                                    <div class="d-flex justify-content-between cmbDivisionFilter"><div class="cdivtext">@CmbStatusText</div><MudIcon Icon="@Icons.Material.Rounded.KeyboardArrowDown"></MudIcon></div>
                                </ActivatorContent>
                                <ChildContent>
                                    <MudMenuItem OnTouch="@(() => SearchStatus("all"))" OnClick="@(() => SearchStatus("all"))">All Types</MudMenuItem>
                                    <MudMenuItem OnTouch="@(() => SearchStatus("Issue"))" OnClick="@(() => SearchStatus("Issue"))">Issue</MudMenuItem>
                                    <MudMenuItem OnTouch="@(() => SearchStatus("Purchase"))" OnClick="@(() => SearchStatus("Purchase"))">Purchase</MudMenuItem>
                                </ChildContent>
                            </MudMenu>
                        </div>
                        <div>
                            <MudTable Class="stable" Height="540px" Items="TRANSACTIONS.Where(e => e.ConsumableId == obj.Id)" Context="item" SortLabel="Sort By" FixedHeader="true" Elevation="0" HorizontalScrollbar="true" Dense="true" Hover="true" Bordered="false" Striped="true">
                                <HeaderContent>
                                    <MudTh Class="" Style="background: #e9ecef; font-weight: bold; font-size: 15px;">Code</MudTh>
                                    <MudTh Class="" Style="background: #e9ecef; font-weight: bold; font-size: 15px;">Type</MudTh>
                                    <MudTh Class="" Style="background: #e9ecef; font-weight: bold; font-size: 15px;">Assigned To</MudTh>
                                    <MudTh Class="" Style="background: #e9ecef; font-weight: bold; font-size: 15px;">
                                        <MudTableSortLabel SortBy="new Func<Cons_TransactionT, object>(x=>x.Transact_Qty)">
                                            Quantity
                                        </MudTableSortLabel>
                                    </MudTh>
                                    <MudTh Class="" Style="background: #e9ecef; font-weight: bold; font-size: 15px;">
                                        <MudTableSortLabel SortBy="new Func<Cons_TransactionT, object>(x=>x.CreatedOn)">
                                            On
                                        </MudTableSortLabel>
                                    </MudTh>
                                    <MudTh Class="" Style="background: #e9ecef; font-weight: bold; font-size: 15px;">Action</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Code"><b>@item.Transact_Code</b></MudTd>
                                    <MudTd DataLabel="Type">
                                        @if (item.Transact_Type.Equals("Issue"))
                                        {
                                            <span style="color: #be1313">@item.Transact_Type</span>
                                        }
                                        else
                                        {
                                            <span style="color: #397763">@item.Transact_Type</span>
                                        }
                                    </MudTd>
                                    <MudTd DataLabel="Employee">
                                        <EmployeeNamePosition verify="@item.Employee?.Verify_Id" />
                                    </MudTd>
                                    <MudTd DataLabel="Qty">@item.Transact_Qty @obj.UOM?.Code</MudTd>
                                    <MudTd DataLabel="Transaction Date">@item.CreatedOn?.ToString("MMM dd yyyy")</MudTd>
                                    <MudTd DataLabel="Transaction Date">
                                        <MudIconButton Class="btnShow" OnClick="(() => ShowTransactionDialog(item.Id))" Icon="@Icons.Material.Rounded.Info" aria-label="Show"></MudIconButton>
                                    </MudTd>
                                </RowTemplate>
                                <PagerContent>
                                    <MudTablePager PageSizeOptions="new int[] { 10, 25, int.MaxValue }" InfoFormat="@($"Right {transactionFormat}")" HorizontalAlignment="HorizontalAlignment.Right" />
                                </PagerContent>
                            </MudTable>
                        </div>
                    </div>
                </MudTabPanel>
                @* <MudTabPanel TabContent="TabHeader(2)">
                    <div class="mainasssec">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="spantitle">Reports</span>
                        </div>

                        <div class="container-fluid">
                            <div>Top Issued Employees</div>
                            @foreach (var item in TopTransEmployee)
                            {
                                <div class="row">
                                    <div class="col-sm-12 col-md-6">
                                        @item.FirstName @item.LastName
                                    </div>
                                    <div class="col-sm-12 col-md-6">
                                        @TRANSACTIONS.Where(e => e.EmployeeId == item.Id).Sum(e=>e.Transact_Qty)
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </MudTabPanel> *@
            </MudTabs>
        </div>
    </MudItem>
</MudGrid>

<MudDrawer @bind-Open="@detailsPanelOpen" Width="500px" Height="100%" Anchor="@anchor" Elevation="1" Variant="@DrawerVariant.Temporary" Style=" margin: 10px;">
    <div class="container-fluid drawerdetails">
        <div class="row"><div class="col-12 drawertitle">Update</div></div>
        <div class="row">
            <div class="col-12">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Asset Code</MudText>
                <MudTextField @bind-Value="obj.AssetCode" ReadOnly Variant="Variant.Outlined" Margin="Margin.Dense" Style="font-weight: bold;" />
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Type</MudText>
                <MudSelect @bind-Value="obj.TypeId" Variant="Variant.Outlined" Margin="Margin.Dense">
                    <MudSelectItem Disabled="true" Value="0">Select</MudSelectItem>
                    @foreach (var sec in TYPES)
                    {
                        <MudSelectItem Value="@sec.Id">@sec.AType_Name</MudSelectItem>
                    }
                </MudSelect>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Category</MudText>
                <MudSelect @bind-Value="obj.CategoryId" Variant="Variant.Outlined" Margin="Margin.Dense">
                    <MudSelectItem Disabled="true" Value="0">Select</MudSelectItem>
                    @foreach (var sec in CAT)
                    {
                        <MudSelectItem Value="@sec.Id">@sec.ACat_Name</MudSelectItem>
                    }
                </MudSelect>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Sub Category</MudText>
                <MudSelect @bind-Value="obj.SubCategoryId" Variant="Variant.Outlined" Margin="Margin.Dense">
                    <MudSelectItem Disabled="true" Value="0">Select</MudSelectItem>
                    @foreach (var sec in SUBCAT.Where(e => e.CategoryId == obj.CategoryId))
                    {
                        <MudSelectItem Value="@sec.Id">@sec.ASubCat_Name</MudSelectItem>
                    }
                </MudSelect>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Location</MudText>
                <MudSelect @bind-Value="obj.AreaId" Variant="Variant.Outlined" Margin="Margin.Dense" Style="margin-bottom: 5px;">
                    <MudSelectItem Disabled="true" Value="0">Select</MudSelectItem>
                    @foreach (var sec in AREA)
                    {
                        <MudSelectItem Value="@sec.Id">@sec.Name</MudSelectItem>
                    }
                </MudSelect>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-lg-6">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Name</MudText>
                <MudTextField @bind-Value="obj.Cons_Name" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </div>
            <div class="col-12 col-lg-6">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Description</MudText>
                <MudTextField @bind-Value="obj.Cons_Desc" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Product ID</MudText>
                <MudTextField @bind-Value="obj.ProductID" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-lg-6">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Quantity</MudText>
                <MudNumericField @bind-Value="obj.Quantity" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </div>
            <div class="col-12 col-lg-6">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Unit of Measurement (UOM)</MudText>
                <MudSelect @bind-Value="uomHolder" Variant="Variant.Outlined" Margin="Margin.Dense" Style="margin-bottom: 5px;">
                    <MudSelectItem Disabled="true" Value="0">Select</MudSelectItem>
                    @foreach (var sec in UOM)
                    {
                        <MudSelectItem Value="@sec.Id">@sec.Description</MudSelectItem>
                    }
                </MudSelect>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-lg-6">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Purchase Date</MudText>
                <MudDatePicker Editable="true" @bind-Date="obj.PurchaseDate" Mask="@(new DateMask("MM/dd/yyyy"))" DateFormat="MM/dd/yyyy" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </div>
            <div class="col-12 col-lg-6">
                <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Purchase Amount</MudText>
                <MudTextField @bind-Value="obj.TotalPurchaseAmount" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="d-flex flex-column" style="margin-bottom: 10px;">
                    <div class="flex-grow-1">
                        <MudText Align="Align.Start" Style="color: #6A707D;" Typo="Typo.caption">Remarks</MudText>
                        <div class="d-flex">
                            <MudTextField @bind-Value="newRemark" Variant="Variant.Outlined" Margin="Margin.Dense" Style="margin-bottom: 5px;" />
                            <MudButton Style="width: 127px;" Class="btnsmallsapos" Variant="Variant.Filled" OnClick="@(() => AddNewRemark(obj.AssetCode, newRemark))">Add Remark</MudButton>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap flex-grow-1">
                        <MudChipSet AllClosable="true" OnClose="CloseRemark">
                            @foreach (var item in REMARKS)
                            {
                                <MudChip Style="color: #fafaf5; background-color: #757a90;" Text="@item.Remark"></MudChip>
                            }
                        </MudChipSet>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-save" @onclick="SaveUpdate">Save</button>
                </div>
            </div>
        </div>
    </div>
</MudDrawer>
